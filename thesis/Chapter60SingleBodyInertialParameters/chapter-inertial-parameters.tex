\chapter{Rigid Body Inertial Parameters Identification}
\label{ch:inertialParameters}
\graphicspath{{Chapter60SingleBodyInertialParameters/Figs/}}

\section{Introduction}
A large part of existing robotic systems are modeled as a system of multiple rigid bodies. 
The knowledge of the dynamical characteristics of these rigid bodies is a key assumption of model-based control and estimation techniques, such as the one presented in Chapter~\ref{chap:extForceAndJntTorqueEstimation}. The dynamics of a rigid body, i.e. how the acceleration of a rigid body is related to the forces applied on it, is completely described by the mass distribution of the body in the 3D space. 
The mass distribution itself is completely described by 10 \emph{inertial parameters} \citep{handbookident}. These parameters may be available if a good Computer-Aided Design (CAD) model of the robot is available, but often such models are either not available, or the mass distribution of the rigid bodies in the robot changes during operation, as in the case of an end effector that grabs and heavy object. 

% Inertial parameters identification is important, both for estimating the inertial parameters of an unknown payload or more generally to estimate inertial parameters of the links of a robot, that may be either unknown due to mismatch between design (CAD) models or because they are changing in time (payload estimation in a sense is a particular kind of inertial parameter identification: in this case the link that is changing inertial properties is the end effector \citep{hollerbach2008model}).

 Inverse robot dynamics models can be written linearly with respect to the inertial parameters of the rigid bodies composing the robot. Classical identification techniques \citep{handbookident,ayusawa2013} consider the parameters of each body to be an element of the Euclidean space $\mathbb{R}^{10}$. Exploiting this fact, the inertial parameters identification problem has been classically posed as a \emph{Linear Least Square} optimization problem \citep{handbookident}. The resulting problem is convenient from a computational point of view, but it neglects the fact that not all vectors in $\mathbb{R}^{10}$ can be generated by a physical rigid body, i.e. it is possible that some inertial parameters are identified even if no physical rigid body could generate them. 
% We call inertial parameters that can correspond to real rigid body \emph{fully physically consistent} inertial parameters.

A necessary condition for the inertial parameters to be generated by a physical rigid body was first proposed in \citep{yoshida1994}: the \emph{physical consistency} condition.  
% to be the positiveness of the rigid body mass and the positive definiteness of the 3D inertia matrix at the center of mass of the body. 
This condition is important for control purposes because it ensures, if it is valid for all the links of a robot, the positive definiteness and the invertibility of the joint mass matrix \citep{yoshida2000}. This property is a key assumption in proving the stability of model-based control laws. 
The \emph{physical consistency} has been enforced in identification of inertial parameters  using several techniques: \citep{yoshida2000,mata2005,gautier2013industrial,gautier2013positive,sousa2014,jovic2015}. However this condition is not \emph{sufficient}: it is possible that some inertial parameters that respect this condition do not correspond to any physical body: in particular this condition does not encode the \emph{triangle inequalities} of the 3D inertia matrix \cite[Chapter 3]{wittenburg2007dynamics}, as it will be explained in the remainder of the chapter.

The main contribution of this paper is a new necessary and \emph{sufficient} condition for the inertial parameters to be generated by rigid body: the \emph{full physical consistency} condition. We show that this condition implies the already proposed \emph{physical consistency} condition and that the triangle inequalities are respected. Furthermore, we propose a nonlinear optimization formulation that takes into consideration this constraint by using state of the art optimization techniques on non-Euclidean manifolds \citep{brossette2015humanoid}. The proposed optimization technique is validated with a rigid body inertial identification experiment on the arm of the iCub humanoid robot.

For the sake of simplicity, in this chapter, we only consider the problem of identifying the inertial parameters of a single rigid body. However, the \emph{full physical consistency} condition and the optimization on manifolds are general contributions, that could be applied to the case of the identification of inertial parameters in generic multibody structures. 

The chapter is organized as follows. Section~\ref{sec:background-on-inertial-parameters} presents the
notations  used  in  the  chapter and the background on rigid body dynamics.
Section~\ref{sec:full-physical-consistency} details the proposed \emph{full physical consistency} condition, the proposed nonlinear parametrization of the inertial parameters that ensures that this condition is always satisfied and the optimization technique on the manifold of the proposed parametrization.
Section~\ref{sec:single-body-experimental-results} describe the experiments used for validation.

The notation used in the chapter is summarized in the next table.

\[
  \left[
      \begin{tabular}{@{\quad}m{.05\textwidth}@{\quad}m{.83\textwidth}}
        {\Huge \faInfoCircle} &
          \raggedright%
           \textbf{Notation used in Chapter~\ref{ch:inertialParameters}} \par
          \begin{tabular}{@{}p{0.24\textwidth}p{0.55\textwidth}@{}}
              $A$ & Inertial frame. \\
              $B$ & Body frame. \\
              $\bbM := \ls_B \bbM_B$ & 6D inertia matrix of body $B$ expressed in the $B$ frame.  \\
              $m$ & Mass of the rigid body. \\
              $c := \ls^B c$ & Center of mass of the rigid body, expressed in the $B$ frame. \\
              $I_B$ & 3D inertia of the body $B$, expressed with the orientation of the body frame $B$ and w.r.t. the origin of $B$. \\
              $\alpha^g := \ls^B \alpha^g_{A,B} \in \R^3$ & Angular velocity of the body expressed in body frame. \\ 
              $\omega := \ls^B \omega_{A,B} \in \R^3$ & Angular velocity of the body expressed in body frame. \\
          \end{tabular}
      \end{tabular}
    \right]
\]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Background on Rigid Body Inertial Parameters}
\label{sec:background-on-inertial-parameters}

\subsection{Rigid Body Dynamics} 
% The generic position of a body-fixed point $p$ of the body in inertial frame
% is given as:
% $$
% p = \ls^A R_B r + p_B 
% $$

% Deriving this equation we get the expression for the generic velocity of a point in the body, as a function of its body coordinates $r$:
% \begin{equation}
% \label{eq:pointVel}
% \dot{p} = \omega \times r + \dot{p}_B 
% \end{equation}.

% The kinetic energy of the body is given by
% \begin{equation}
% \label{eq:enKin}
% E_k = \iiint\limits_{\mathbb{R}^3} \frac{1}{2} \dot{p}^2(r) \rho(r) dr . 
% \end{equation}

% Assuming that the rigid body is subject to a uniform gravitational potential field with a constant gravitational acceleration vector $g \in \mathbb{R}^3$ expressed in the A frame, the potential energy is given as:
% \begin{equation}
% \label{eq:enPot}
% U = \iiint\limits_{\mathbb{R}^3} e_3^T \dot{p}(r) \rho(r) dr . 
% \end{equation}

The Newton-Euler equations using the \emph{proper sensor acceleration} \eqref{eq:properSensorAccelerationNewtonEuler} are given by:
\begin{equation}
\label{eq:newtonEuler}
\bbM \alpha^g 
+ 
\begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix}
\bar{\times}^* \bbM 
\begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix}
= \phi
\end{equation}

where $\alpha^g := \alpha^g_{A,B} \in \R^6$ is the \emph{sensor proper} acceleration, 
$\omega := \ls^B \omega_{A,B} \in \R^3$ is the angular velocity of the body expressed in body frame, $\phi := \ls_B\phi_{B}$ is the net force-torque acting on the robot expressed in $B$ frame and
$\bbM \in \mathbb{R}^{6 \times 6}$ is the 6D inertia matrix (also known as \emph{spatial inertia} in \cite{featherstone2008}) expressed in body frame $B$
\begin{equation}
    \bbM = \begin{bmatrix} m 1_{3} & -m c^\wedge \\ 
                        m c^\wedge           & {I}_B 
        \end{bmatrix}.
\end{equation}
Where:
\begin{itemize}
    \item $m \in \mathbb{R}$ is the mass of the rigid body,
    \item $c \in \mathbb{R}^3 := \ls^B c$ is the center of mass of the rigid body, expressed in the frame $B$,
    \item $I_B \in \mathbb{R}^{3\times3}$ is the 3D inertia matrix of the rigid body, expressed with the orientation of frame $B$ and with respect to the frame $B$ origin. 
\end{itemize} 

\subsection{Inertial parameters}
The 6D inertia matrix is parametrized by 10 parameters, usually called the \emph{inertial parameters} of the rigid body \citep{handbookident}, that are defined as $\pi \in \mathbb{R}^{10}$:
\begin{equation}
\label{eq:inertialParametersVector}
    \pi = 
    \begin{bmatrix}
    m \\
    m c \\
    \operatorname{vech}(I_B)
    \end{bmatrix} .
\end{equation}

The product of a generic vector $\begin{bmatrix} v \\ \omega \end{bmatrix} \in \R^6$ by the 6D inertia matrix $\bbM$ can be written as a product of a matrix in $\R^{6 \times 10}$ for the vector of inertial parameters $\pi$:
\begin{equation}
  \bbM \begin{bmatrix} v \\ \omega \end{bmatrix} 
  =
  D\left(\begin{bmatrix} v \\ \omega \end{bmatrix}\right)
  \pi
  =
\begin{bmatrix}
v            & \omega^\wedge & 0_{3 \times 6} \\
0_{3\times1} & -v^\wedge     & \omega \bullet 
\end{bmatrix} \pi
\end{equation}

where the matrix $\omega \bullet$ is defined such that $\omega \bullet \operatorname{vech}({I_B}) = {I_B} \omega$:
\begin{equation}
\omega \bullet = \begin{bmatrix} \omega_x & \omega_y & \omega_z & 0 & 0 & 0 \\ 
                                    0 & \omega_x & 0 & \omega_y & \omega_z & 0 \\ 
                                    0 & 0 & \omega_x & 0 & \omega_y & \omega_z \end{bmatrix}.
\end{equation}

\begin{proposition}[Newton-Euler equations linearity in the inertial parameters]
The Newton-Euler equations \eqref{eq:newtonEuler} can be written linearly \citep{garofalo2013closed,handbookident} in the inertial parameters~\eqref{eq:inertialParametersVector}:
\begin{equation}
\label{eq:inertialRegressor}
Y(\alpha^g, \omega) \pi 
=
\bbM \alpha^g + 
\begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix}
\bar{\times}^* \bbM 
\begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix}
= \phi, 
\end{equation}
with:
\begin{equation}
  Y(\alpha^g,\omega) =  D \left(\alpha^g \right) + \begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix}
\bar{\times}^* D\left( \begin{bmatrix} 0_{3 \times 1} \\ \omega \end{bmatrix} \right) .
\end{equation}
\end{proposition}

\subsection{Relationship between the inertial parameters and the density function}
The mass distribution of a rigid body in space is described by its density function:
\begin{equation}
\rho(\cdot): \mathbb{R}^3 \mapsto \mathbb{R}_{\ge 0} .
\end{equation}
The domain of this function is the points of body expressed in the body-fixed frame $B$.
We consider the density equal to zero for the points outside the volume of the rigid body, so we can define the domain of $\rho(\cdot)$ to be all the points in the 3D space $\mathbb{R}^3$.

The inertial parameters are obviously a functional of the density $\rho(\cdot)$, in particular, we can define the functional $\pi_{d}(\cdot) : (\mathbb{R}^3 \mapsto \mathbb{R}_{\ge 0}) \mapsto \mathbb{R}^{10}$ that maps the density function to the corresponding inertial parameters: 
\begin{IEEEeqnarray}{rCl}
\label{eq:pid}
   \pi_{d}(\rho(\cdot)) &=&
    \begin{bmatrix}
    m(\rho(\cdot)) \\
    mc(\rho(\cdot)) \\
    \operatorname{vech}(I_B(\rho(\cdot))) 
    \end{bmatrix} = \nonumber \\ &=& 
   \begin{bmatrix}
     \iiint\limits_{\mathbb{R}^3} \rho(r) dr \\
     \iiint\limits_{\mathbb{R}^3} r \rho(r) dr \\
     \operatorname{vech}\left(
     \iiint\limits_{\mathbb{R}^3} (r^\wedge)^T r^\wedge \rho({r}) d{r} \right)
           \end{bmatrix} .
\end{IEEEeqnarray}

% \subsubsection{Mass of the body}
% The mass of the body is the integral of the body density over the space:
% \begin{equation}
% \label{eq:massDensity}
% \iiint\limits_{\mathbb{R}^3} \rho(r) dr = m 
% \end{equation}

% \subsubsection{First moment of mass}
% The \emph{first moment of mass} $mc$ is then defined as:
% \begin{equation}
% mc = {\iiint\limits_{\mathbb{R}^3} r \rho(x) dr}
% \end{equation}

% The center of mass is then defines simply as the division between the first moment of mass and the mass:
% \begin{equation}
%     c = \frac{mc}{m}
% \end{equation}

% \subsubsection{Inertia matrix with respect to the body frame origin}
% The 3D inertia matrix of the body is given by:
% $$
% I_B = \iiint\limits_{\mathbb{R}^3} S^T(r) r^\wedge \rho(r) dr = \iiint\limits_{\mathbb{R}^3} (r^T r 1_{3} - r r^T) \rho(r) dr
% $$

% It easy to very that the 3D inertia matrix is symmetric 
% $$
% I_B^T = \iiint\limits_{\mathbb{R}^3} (S^T(r) r^\wedge)^T \rho(r) dr = \iiint\limits_{\mathbb{R}^3} S^T(r) r^\wedge \rho(r) dr = I_B
% $$

% \subsubsection{Inertia matrix elements}
% \begin{align}
% I_B^{xx} = \iiint\limits_{\mathbb{R}^3} (y^2 + z^2) \rho(r) dr \\
% I_B^{xy} = I_B^{yx} = \iiint\limits_{\mathbb{R}^3} -xy~\rho(r) dr \\
% I_B^{xz} = I_B^{zx} = \iiint\limits_{\mathbb{R}^3} -xz~\rho(r) dr \\
% I_B^{yy} = \iiint\limits_{\mathbb{R}^3} (x^2 + z^2) \rho(r) dr \\
% I_B^{yz} = I_B^{yz} = \iiint\limits_{\mathbb{R}^3} -yz~\rho(r) dr \\
% I_B^{zz} = \iiint\limits_{\mathbb{R}^3} (x^2 + y^2) \rho(r) dr \\
% \end{align}

\subsection{3D Inertia at the Center of Mass and Principal Axes}
\label{subsec:principalAxis}

The 3D inertia at the center of mass is defined as

\begin{equation}
\label{eq:comInertiaDef}
I_C = \iiint\limits_{\mathbb{R}^3} ((r-c)^\wedge)^T (r-c)^\wedge \rho(r) dr .
\end{equation}

Exploiting the fact that $(\cdot)^\wedge$ is linear, the inertia matrix with respect to the center of mass can be written as: 
% \begin{align*}
% I_C = &\iiint\limits_{\mathbb{R}^3} \left( S^T(r) r^\wedge - S^T(r) S(c) - ( c^\wedge )^T r^\wedge + ( c^\wedge )^T S(c) \right) \rho(r) dr = \\
%  = &\iiint\limits_{\mathbb{R}^3}  S^T(r) r^\wedge \rho(r) dr -S^T \left( \iiint\limits_{\mathbb{R}^3}  r  \rho(r) dr \right)  S(c) + \\
% &-( c^\wedge )^T S \left( \iiint\limits_{\mathbb{R}^3}  r  \rho(r) dr \right) + ( c^\wedge )^T S(c) \iiint\limits_{\mathbb{R}^3}  \rho(r) dr = \\
% = &I_B -  m ( c^\wedge )^T S(c) -  m ( c^\wedge )^T S(c) + m ( c^\wedge )^T S(c) = \\ = &I_B -  m ( c^\wedge )^T S(c) =  I_B +  m S(c) S(c) 
% \end{align*}

\begin{equation}
I_C =  I_B +  m S(c) S(c) .
\end{equation}

This result is known as \emph{parallel axis theorem}. 

As $I_C$ is symmetric, it can be diagonalized with an orthogonal matrix $Q \in SO(3)$: 
\begin{equation}
I_C = Q \operatorname{diag}{(J)}  Q^T .
\end{equation}

Using \eqref{eq:comInertiaDef} the diagonal matrix $\operatorname{diag}{(J)}$ (with $J \in \mathbb{R}^3$) can be written as:
\begin{IEEEeqnarray}{rCl}
\operatorname{diag}{(J)} &=& \iiint\limits_{\mathbb{R}^3} Q^T ((r-c)^\wedge)^T (r-c)^\wedge Q \rho(r) dr = \nonumber \\
     &\iiint\limits_{\mathbb{R}^3}& ((Q^T (r-c))^\wedge)^T (Q^T(r-c))^\wedge \rho(r) dr .
\end{IEEEeqnarray}

The operation mapping the body point $r$ to $Q^T(r-c)$ can be interpreted as a change of 
reference frame, from the body frame $B$ to a frame $C$ (a \emph{principal axes} frame) whose origin is the center 
of mass of the body and whose orientation is one in which the $I_C$ matrix is diagonal.

By expressing with $\tilde{r} = Q^T \left( r-c \right)$ the generic point of the body expressed in the $C$ frame, and with $\tilde{\rho}(\tilde{r})$ the density with respect to the $C$ frame, we can write 
$\operatorname{diag}{J}$ as:
\begin{IEEEeqnarray}{rCl}
\operatorname{diag}{J} &=&   \iiint\limits_{\mathbb{R}^3}
(\tilde{r}^\wedge)^T \tilde{r}^\wedge \rho(\tilde{r}) d\tilde{r} .
\end{IEEEeqnarray}
The elements of the J vector are: 
\begin{IEEEeqnarray}{rCl}
J_{x} = \iiint\limits_{\mathbb{R}^3} ({\tilde{y}}^2 + {\tilde{z}}^2) \tilde{\rho}(\tilde{r}) dr' , \IEEEyessubnumber \\
J_{y} = \iiint\limits_{\mathbb{R}^3} (\tilde{x}^2 + \tilde{z}^2) \tilde{\rho}(\tilde{r}) d\tilde{r} , \IEEEyessubnumber \\
J_{z} = \iiint\limits_{\mathbb{R}^3} (\tilde{x}^2 + \tilde{y}^2) \tilde{\rho}(\tilde{r}) d\tilde{r} \IEEEyessubnumber .
\end{IEEEeqnarray}
We can write them as:
\begin{IEEEeqnarray}{rClrClrCl}
J_{x} &=& L_{y} + L_{z} , \quad
J_{y} &=& L_{x} + L_{z} , \quad
J_{z} &=& L_{x} + L_{y} .
\end{IEEEeqnarray}
\begin{IEEEeqnarray}{rClrCl}
L_{x} &=& \iiint\limits_{\mathbb{R}^3} {\tilde{x}}^2  \tilde{\rho}(\tilde{r}) d\tilde{r}, \quad
L_{y} &=& \iiint\limits_{\mathbb{R}^3} {\tilde{y}}^2  \tilde{\rho}(\tilde{r}) d\tilde{r}, 
\end{IEEEeqnarray}
\begin{IEEEeqnarray}{rCl}
L_{z} &=& \iiint\limits_{\mathbb{R}^3} {\tilde{z}}^2  \tilde{\rho}(\tilde{r}) d\tilde{r}.
\end{IEEEeqnarray}
Where $L_x , L_y , L_z$ are  the \emph{central second moments of mass} of the density $\tilde{\rho}(\tilde{r})$.
It is clear that the non-negativity of $\tilde{\rho}(\tilde{r})$ constraints $L = \begin{bmatrix} L_{x} & L_{y} & L_{z} \end{bmatrix}^T$ 
to be non-negative as well.
Furthermore, it is possible to see that the non-negativity of $L$ induces the \emph{triangular inequalities} on $\operatorname{diag}{\left(J\right)}$:
\begin{IEEEeqnarray}{lCrlCrlCr}
\label{eq:triangularInequalities}
 J_{x} &\leq& J_{y} + J_{z} , \quad 
 J_{y} \ &\leq& \ J_{x} + J_{z}, \quad 
 J_{z} \ &\leq& \ J_{x} + J_{y} .
\end{IEEEeqnarray}

% \begin{theorem}
% If the 3d inertia at the center of mass is positive definite, then all the 3d inertia at any arbitrary body fixed point are positive definite, i.e. 
% $$I_C \succeq 0 \implies I_B \succeq 0 ~ \forall B$$
% \end{theorem}

% \begin{proof}
% The proof is given in the Appendix.
% \end{proof}


% The mapping from the proposed parametrization to the classical inertial parameters vector ($\pi(p)$):
% \begin{align}
% m &= m \\
% mc &= m c \\
% \text{vech}(I_B) &= \text{vech}(R \operatorname{diag}{((P+P^T)L)} R^T - m S(c) S(c))
% \end{align}
% If we define as $p \in \mathbb{R}^{16}$ the following serialization of the inertial parameters:
% $$
% p 
% = 
% \begin{bmatrix}
% m \\
% c \\ 
% vec(R) \\
% L 
% \end{bmatrix}
% $$

%% We can then define the function $\pi(p)$ and its derivative is:
%% $$
%% \frac{\partial \pi}{\partial p}
%% =
%% \begin{bmatrix}
%% 1 & 0_{1 \times 3} & 0_{1 \times 9} & 0_{1 \times 3} \\
%% c & m I_3 & 0_{1 \times 9} & 0_{1 \times 3} \\
%% \text{vech}(-S(c)S(c))) & m \partial_c \text{vech}(-S(c)S(c))) &\partial_{\text{vec}{R}}  \text{vech}(I_B) & \partial_L  \text{vech}(I_B)\\ 
%% 
%% \end{bmatrix}
%% $$
%% 
%% where: 
%% \begin{align}
%%    \text{vech}(-S(c)S(c)) = 
%%    \text{vech}(c^T c I_3 - c c^T) =
%%    \begin{bmatrix} 
%%    c_y^2 + c_z^2 \\
%%    - c_x c_y \\
%%    - c_x c_z \\
%%    c_x^2 + c_z^2 \\
%%    - c_y c_z \\
%%    c_x^2 + c_y^2 
%%    \end{bmatrix}
%%    \\
%%     m \partial_c \text{vech}(-S(c)S(c))) =
%%     m 
%%     \begin{bmatrix} 
%%    0 & 2c_y & 2c_z \\
%%   - c_y & -c_x & 0 \\
%%    - c_z & 0    & -c_x \\
%%    2c_x &  0 &  2c_z \\
%%    0    & -c_z   & - c_y \\
%%   2c_x & 2c_y & 0 
%%    \end{bmatrix}
%% \end{align}
%% \begin{align}
%%    \partial_{R_{i,j}} \text{vech}(I_B) =
%%     \text{vech}(\Delta_{i,j} \operatorname{diag}{((P+P^T) L)} R^T + R \operatorname{diag}{((P+P^T)L)} \Delta_{i,j}^T) &
%% \end{align}
%% \begin{align}
%%     \partial_{L_i}  \text{vech}(I_B) = 
%%      \text{vech}(R \operatorname{diag}{((P+P^T) L )} R^T) &
%% \end{align}
%% Where $\Delta_{i,j}$ is the 3x3 matrix with all element zero except for the $i,j$ element and $e_i$ is the 3x1 vector with all element zero except for the $i$th element.

% Defining the $\frac{\partial \pi}{\partial p}$ is possible to convert all cost function regressor written for the classical linear parametrization in gradient of the new non-linear parametrization.

\subsection{Inertial Parameters Identification}
Assuming that $N$ values for $F$,$A_g$ and $V$ are measured, equation \eqref{eq:inertialRegressor} can be used to estimate $\pi$ solving the following optimization problem:
\begin{equation}
\label{eq:optimizationProblemLinear}
 \hat{\pi} =  \argmin_{\pi \in \mathbb{R}^{10}}\ ~ \sum_{i = 1}^N \left\| Y(\alpha^g_i, \omega_i)\pi - \rmf_i \right\|^2 . \\
\end{equation}

However, this optimization does not take into account the physical properties of the inertial parameters $\pi$. For this reason, the following definition was introduced.
\begin{definition}
\label{def:physicalConsistency}
A vector of inertial parameters $\pi$ is called \emph{physical consistent} \citep{yoshida1994,yoshida2000} if: 
\begin{IEEEeqnarray}{rClrCl}
m(\pi) &\geq& 0 , \qquad I_C(\pi) &\succeq& 0 .
\end{IEEEeqnarray}
\end{definition}
This condition has nice properties (it ensures that the matrix $M$ is always invertible), but is still possible to find some \emph{physical consistent} inertial parameters that can't be generated by a physical density. 

\section{Full Physical Consistency}
\label{sec:full-physical-consistency}
\input{./Chapter60SingleBodyInertialParameters/fullPhysicalConsistency}

For parametrize the 3D inertia matrix ensuring the properties described in subsection \ref{subsec:principalAxis} we choose the \emph{second moments of mass} $L \in \mathbb{R}^3_{\geq 0}$ to be components of our parametrization. In the following, we will show how this choice ensures the \emph{full physical consistency} of the resulting inertial parameters. 

% The relation between $L = \begin{bmatrix} L^{xx} & L^{yy} & L^{zz} \end{bmatrix}^T \in \mathbb{R}^3$ and  $J = \begin{bmatrix} J^{xx} & J^{yy} & J^{zz} \end{bmatrix}^T \in \mathbb{R}^3$ can be written as:
% \begin{align}
% J = PL + P^T L = (P + P^T) L\\
% P =
% \begin{bmatrix}
% 0 & 1 & 0 \\
% 0 & 0 & 1 \\
% 1 & 0 & 0 
% \end{bmatrix}
% \end{align}
% where $P$ is a permutation matrix. 

% From the non-negativity of $\rho(r)$ we obtain as a necessary condition the non-negativity of $L_{x}$ , $L_{y}$, $L_{z}$. However, their non-negativity implies the non-negativity of $J_{x}$ , $J_{y}$, $J_{z}$, that implies the positive semi-definitess of $I_C$, i.e. the \emph{physical consistency} of the associated inertial parameters.
% \begin{IEEEeqnarray}{rCl}
% L_{x} , L_{y}, L_{z} \geq 0 \implies J_{x} , J_{y}, J_{z} \geq 0 \implies  I_C \succeq 0
% \end{IEEEeqnarray}

The inertial parameters of a rigid body can then be parametrized by an element $\theta \in \mathfrak{P} = \mathbb{R}_{\ge 0} \times \mathbb{R}^3 \times  SO(3) \times \mathbb{R}_{\ge 0}^3$. In particular the components of $\theta$ are:
\begin{itemize}
    \item $m \in \mathbb{R}_{\ge 0}$ the mass of the body 
    \item $c \in \mathbb{R}^3$ the center of mass of the body 
    \item $Q \in SO(3)$ the rotation matrix between the body frame and the frame of principal axis at the center of mass
    \item $L \in \mathbb{R}_{\ge 0}^3$ the second central moment of mass along the principal axes 
\end{itemize}

In other terms, there is a function $\pi_p(\theta) : \mathfrak{P} \mapsto \mathbb{R}^{10}$ that maps this new parametrization to the corresponding inertial parameters:
\begin{IEEEeqnarray}{rCCCl}
\label{eq:pip}
\pi_p(\theta) 
&=&
    \begin{bmatrix}
    m(\theta) \\
    mc(\theta) \\
    \operatorname{vech}\left(I_B(\theta)\right) \\
    \end{bmatrix}  
    &=& 
    \begin{bmatrix}
    m \\
    mc \\
    \operatorname{vech}\left( Q \operatorname{diag}{(PL)}  Q^T - m S(c) S(c) \right) \\
    \end{bmatrix} \nonumber
\end{IEEEeqnarray}
Where $P = \left[ \begin{matrix}
0 & 1 & 1 \\
1 & 0 & 1 \\
1 & 1 & 0 
\end{matrix} \right]$ is a matrix that maps $L$ to $J$.

\begin{theorem}
\label{thm:mainTheorem}
For each $\theta \in \mathfrak{P}$, there exists a density function $\rho(\cdot) : R^3 \mapsto R_{\geq 0}$ such that $\pi_d(\rho(\cdot)) = \pi_p(\theta)$, i.e. every  $\theta \in \mathfrak{P}$ generates \emph{fully physical consistent} inertial parameters.
\end{theorem}
\begin{proof}
\label{proof:mainTheorem}
% Given an element $\theta = (m,c,Q,L) \in \ipspace$, it always exists at least density function $\rho(\cdot): R^3 \mapsto R_{\geq 0}$ such that $\pi_p(\theta) = \pi_d(\rho(\cdot))$. 
We prove the statement in a constructive way: given an arbitrary element $\theta = (m,c,Q,L) \in \ipspace$ we build a density function $\rho(\cdot): \mathbb{R}^3 \mapsto \mathbb{R}_{\geq 0}$ such that $\pi_p(\theta) = \pi_d(\rho(\cdot))$. 
For example we can think of a cuboid of uniform unit density, with the center of the cuboid coincident with the center of mass of the inertial parameters (given by $c$), with the orientation of its symmetry axis aligned with the $C$ \emph{principal axes} frame defined by the $Q$ rotation matrix and the cuboid sides of lengths $2 d_x$ , $2 d_y$ and $2 d_z$, with:
\begin{equation}
\label{eq:cuboidSize}
    d = 
    \begin{bmatrix}
    d_x &
    d_y &
    d_z 
    \end{bmatrix}^{\top}
    = 
    \begin{bmatrix}
    \sqrt{3 \frac{L_x}{m}} &
    \sqrt{3 \frac{L_y}{m}} &
    \sqrt{3 \frac{L_z}{m}} 
    \end{bmatrix}^{\top}
\end{equation}


Its density function in the $C$ frame is given as:
\begin{equation*}
    \tilde{\rho}(\tilde{r}) = 
  \begin{cases} 
      \hfill 1 \hfill & \text{ if $-d \geq \tilde{r} \geq d$} \\
      \hfill 0 \hfill & \text{otherwise} \\
  \end{cases}
\end{equation*}
while the density function in the $B$ frame is given by:
\begin{equation}
  \label{eq:equivalentCuboidDensity}
    {\rho}({r}) = 
  \begin{cases} 
      \hfill 1 \hfill & \text{ if $-Qd+c \geq {r} \geq Qd+c$} \\
      \hfill 0 \hfill & \text{otherwise} \\
  \end{cases}.
\end{equation}

The density defined in \eqref{eq:equivalentCuboidDensity} and \eqref{eq:cuboidSize} can be seen as a function $\gamma(\cdot) : \ipspace \mapsto (\mathbb{R}^3 \mapsto \mathbb{R}_{\geq 0})$. The theorem is then demonstrated by using \eqref{eq:pid} and \eqref{eq:pip} to verify that:
$$
\pi_d(\gamma(\theta)) = \pi_p(\theta)
$$
is true $\forall~\theta \in \ipspace$.
\end{proof}

Using the parametrization presented in Theorem~\ref{proof:mainTheorem}, it is possible to recast the identification optimization problem \eqref{eq:optimizationProblemLinear} as:
\begin{IEEEeqnarray}{rCl}
\label{eq:optimizationProblemNonLinear}
 \hat{\pi} &=& \pi(\hat{\theta}) \\
% \hat{\theta} &=&  \argmin_{\theta \in \mathbb{R}_{\ge 0} \times \mathbb{R}^3 \times  SO(3) \times \mathbb{R}_{\ge 0}^3} ~ \sum_{i = 1}^N || Y(A^g, V) \pi(\theta) - F ||^2 
\hat{\theta} &=&  \argmin_{\theta \in \mathfrak{P}} \sum_{i = 1}^N \left\| Y(\alpha^g_i, \omega_i)\pi(\theta) - \rmf_i \right\|^2
\end{IEEEeqnarray}

The main advantage of \eqref{eq:optimizationProblemNonLinear} with respect to \eqref{eq:optimizationProblemLinear} is that thanks to Theorem \ref{thm:mainTheorem} the identified inertial parameters $\hat{\pi}$ are ensured to be \emph{fully physically consistent}. However, the optimization variable $\theta$ does not live anymore in a Euclidean space, because $\mathfrak{P}$ includes $SO(3)$, so to solve this optimization problem in this need to either modify or to exploit specific techniques related to the \emph{optimization on manifolds}, as we did in the experiments provided in Section~

\input{Chapter60SingleBodyInertialParameters/physical-consistency-experiments}




